# برومبت شامل لنظام التراخيص والحماية

## المطلوب
أريد منك إنشاء نظام ترخيص متكامل وآمن لتطبيق Electron يتضمن جميع المكونات التالية:

## 1. مدير التراخيص الرئيسي (License Manager)

### المتطلبات الأساسية:
- **الحصول على المعرف الفريد للحاسوب**: استخدام مكتبة `node-machine-id` للحصول على معرف فريد للجهاز
- **تشفير البيانات**: تشفير قوي باستخدام AES-256-GCM مع مفاتيح مشتقة من PBKDF2
- **تخزين آمن**: حفظ بيانات الترخيص مشفرة محلياً باستخدام `electron-store` أو نظام ملفات آمن
- **ربط الترخيص بالجهاز**: ربط كل ترخيص بمعرف الجهاز الفريد لمنع النسخ

### الوظائف المطلوبة:
```javascript
class LicenseManager {
  // إنشاء معرف فريد للجهاز
  generateHWID()
  
  // التحقق من صحة تنسيق مفتاح الترخيص
  validateLicenseFormat(licenseKey)
  
  // تفعيل ترخيص جديد
  activateLicense(licenseKey)
  
  // التحقق من صحة الترخيص المحفوظ
  validateStoredLicense()
  
  // حفظ بيانات الترخيص مشفرة
  storeLicense(licenseKey, hwid)
  
  // تشفير وفك تشفير البيانات
  encryptLicenseData(data)
  decryptLicenseData(encryptedData)
  
  // إزالة الترخيص
  removeLicense()
  
  // الحصول على معلومات الترخيص
  getLicenseInfo()
}
```

## 2. مولد مفاتيح الترخيص

### أنواع المفاتيح المطلوبة:
- **مفاتيح الإنتاج**: مفاتيح عشوائية آمنة للبيع التجاري
- **مفاتيح محددة مسبقاً**: مفاتيح ثابتة للاختبار والعروض التوضيحية
- **مفاتيح مرتبطة بالجهاز**: مفاتيح مولدة خصيصاً لجهاز معين

### التنسيق المطلوب:
- تنسيق: `XXXXX-XXXXX-XXXXX-XXXXX`
- أحرف وأرقام كبيرة فقط
- طول كل قطعة: 4-5 أحرف
- مثال: `DENTA-CLINI-C2025-MAIN1`

### فئات المفاتيح:
```javascript
const LICENSE_CATEGORIES = {
  main: 'مفاتيح العيادات الرئيسية',
  professional: 'مفاتيح احترافية', 
  trial: 'مفاتيح تجريبية ومؤقتة',
  premium: 'مفاتيح VIP ومميزة',
  regional: 'مفاتيح المناطق الجغرافية',
  partners: 'مفاتيح الشركاء'
}
```

## 3. نظام تتبع المفاتيح المستخدمة

### المتطلبات:
- **منع الاستخدام المتكرر**: تتبع المفاتيح المستخدمة لمنع استخدامها على أجهزة متعددة
- **تشفير البيانات**: تشفير معلومات المفاتيح المستخدمة
- **إحصائيات الاستخدام**: تتبع إحصائيات مفصلة عن استخدام المفاتيح

### الوظائف المطلوبة:
```javascript
class UsedLicensesTracker {
  // التحقق من توفر المفتاح
  isLicenseAvailable(licenseKey, currentHWID)
  
  // تسجيل استخدام مفتاح
  markLicenseAsUsed(licenseKey, hwid, additionalData)
  
  // تحديث آخر تحقق
  updateLastValidation(licenseKey, hwid)
  
  // تحرير مفتاح (إلغاء ربطه)
  releaseLicense(licenseKey)
  
  // الحصول على معلومات الاستخدام
  getUsedLicenseInfo(licenseKey)
  
  // إحصائيات الاستخدام
  getUsageStatistics()
}
```

## 4. مولد المفاتيح المرتبطة بالجهاز

### المتطلبات:
- **خوارزمية رياضية**: إنشاء مفاتيح باستخدام خوارزمية رياضية معقدة
- **ربط بالجهاز**: كل مفتاح يعمل فقط على الجهاز المحدد
- **أمان عالي**: حماية قصوى ضد النسخ والقرصنة

### الوظائف المطلوبة:
```javascript
class DeviceBoundLicenseGenerator {
  // الحصول على معرف الجهاز الحالي
  getCurrentDeviceId()
  
  // إنشاء مفتاح مرتبط بجهاز
  generateDeviceBoundLicense(deviceId, metadata)
  
  // التحقق من صحة المفتاح المرتبط
  validateDeviceBoundLicense(licenseKey, deviceId)
  
  // إنشاء مفتاح باستخدام خوارزمية رياضية
  generateAlgorithmicKey(deviceId, metadata)
}
```

## 5. مدقق مفاتيح الإنتاج

### المتطلبات:
- **تحميل من ملف**: قراءة مفاتيح الإنتاج من ملف JSON
- **التحقق السريع**: فحص سريع لصحة المفاتيح
- **معلومات مفصلة**: الحصول على تفاصيل كل مفتاح

### بنية ملف الإنتاج:
```json
{
  "metadata": {
    "title": "مفاتيح ترخيص نظام إدارة العيادة",
    "version": "1.0.0",
    "totalKeys": 1000,
    "generatedAt": "2025-01-01T00:00:00.000Z"
  },
  "licenses": [
    {
      "id": "unique-id",
      "key": "XXXXX-XXXXX-XXXXX-XXXXX",
      "hash": "sha256-hash",
      "metadata": {
        "licenseType": "STANDARD",
        "region": "GLOBAL",
        "isLifetime": true,
        "maxDevices": 1
      }
    }
  ]
}
```

## 6. إعدادات الأمان

### التشفير:
- **خوارزمية**: AES-256-GCM
- **مفتاح الاشتقاق**: PBKDF2 مع 100,000 تكرار
- **الملح**: ملح فريد للتطبيق
- **المفاتيح العشوائية**: استخدام `crypto.randomBytes()`

### التحقق:
- **تنسيق المفتاح**: regex للتحقق من التنسيق
- **ربط الجهاز**: مقارنة معرف الجهاز
- **التوقيت**: تتبع أوقات التفعيل والتحقق

## 7. واجهة المستخدم

### شاشة التفعيل:
- حقل إدخال مفتاح الترخيص
- عرض معرف الجهاز
- رسائل الحالة والأخطاء
- أزرار التفعيل والإلغاء

### شاشة معلومات الترخيص:
- تفاصيل الترخيص الحالي
- حالة التفعيل
- معلومات الجهاز
- خيارات الإدارة

## 8. معالجة الأخطاء

### أنواع الأخطاء:
- تنسيق مفتاح غير صحيح
- مفتاح مستخدم على جهاز آخر
- مفتاح غير صالح أو منتهي الصلاحية
- أخطاء التشفير والتخزين
- أخطاء الشبكة (إن وجدت)

## 9. التكامل مع Electron

### الملفات المطلوبة:
- `licenseManager.js` - المدير الرئيسي
- `productionLicenseValidator.js` - مدقق الإنتاج
- `usedLicensesTracker.js` - متتبع الاستخدام
- `deviceBoundLicenseGenerator.js` - مولد المفاتيح المرتبطة
- `predefinedLicenses.js` - المفاتيح المحددة مسبقاً

### التبعيات المطلوبة:
```json
{
  "node-machine-id": "^1.1.12",
  "electron-store": "^8.1.0",
  "crypto": "built-in"
}
```

## 10. اختبار النظام

### سكريبت الاختبار:
- اختبار إنشاء المفاتيح
- اختبار التفعيل والتحقق
- اختبار الأمان والتشفير
- اختبار منع الاستخدام المتكرر

## ملاحظات مهمة:
1. **الأمان أولاً**: استخدم أقوى طرق التشفير المتاحة
2. **سهولة الاستخدام**: واجهة بسيطة وواضحة للمستخدم
3. **المرونة**: دعم أنواع مختلفة من التراخيص
4. **الموثوقية**: معالجة شاملة للأخطاء
5. **الأداء**: عمليات سريعة وفعالة
6. **التوافق**: يعمل على جميع أنظمة التشغيل المدعومة بـ Electron

هذا النظام يوفر حماية شاملة وآمنة لتطبيقك مع سهولة في الاستخدام والإدارة.

---

## أمثلة عملية للتطبيق

### 1. مثال على إنشاء مدير التراخيص:

```javascript
const { machineIdSync } = require('node-machine-id')
const { createHash, createCipheriv, createDecipheriv, randomBytes, pbkdf2Sync } = require('crypto')
const Store = require('electron-store')
const { app } = require('electron')

class LicenseManager {
  constructor() {
    this.currentHWID = this.generateHWID()
    this.licenseStore = new Store({
      name: 'license-data',
      encryptionKey: 'your-app-license-encryption-key-2025',
      cwd: app.getPath('userData')
    })
  }

  generateHWID() {
    try {
      const machineId = machineIdSync()
      const hash = createHash('sha256')
      hash.update(machineId + 'your-app-salt-2025')
      return hash.digest('hex').substring(0, 32)
    } catch (error) {
      console.error('Error generating HWID:', error)
      const fallbackData = `${process.platform}-${process.arch}-${Date.now()}`
      const hash = createHash('sha256')
      hash.update(fallbackData + 'your-app-salt-2025')
      return hash.digest('hex').substring(0, 32)
    }
  }

  validateLicenseFormat(licenseKey) {
    const regex = /^[A-Z0-9]{4,5}-[A-Z0-9]{4,5}-[A-Z0-9]{4,5}-[A-Z0-9]{4,5}$/
    return regex.test(licenseKey?.trim()?.toUpperCase())
  }

  async activateLicense(licenseKey) {
    if (!this.validateLicenseFormat(licenseKey)) {
      return { isValid: false, error: 'تنسيق مفتاح الترخيص غير صحيح' }
    }

    // التحقق من صحة المفتاح (من قاعدة البيانات أو ملف)
    const isValidKey = await this.verifyLicenseKey(licenseKey)
    if (!isValidKey) {
      return { isValid: false, error: 'مفتاح الترخيص غير صالح' }
    }

    // التحقق من عدم الاستخدام المسبق
    const isAvailable = await this.checkLicenseAvailability(licenseKey)
    if (!isAvailable) {
      return { isValid: false, error: 'مفتاح الترخيص مستخدم على جهاز آخر' }
    }

    // حفظ الترخيص
    const success = await this.storeLicense(licenseKey, this.currentHWID)
    if (success) {
      return {
        isValid: true,
        licenseData: {
          license: licenseKey.trim().toUpperCase(),
          hwid: this.currentHWID,
          timestamp: Date.now(),
          activated: true
        }
      }
    }

    return { isValid: false, error: 'فشل في حفظ بيانات الترخيص' }
  }
}
```

### 2. مثال على مولد المفاتيح:

```javascript
const crypto = require('crypto')

class LicenseKeyGenerator {
  constructor() {
    this.charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'
    this.segmentLength = 5
    this.segmentCount = 4
  }

  generateSecureRandomChar() {
    const randomBytes = crypto.randomBytes(1)
    const randomIndex = randomBytes[0] % this.charset.length
    return this.charset[randomIndex]
  }

  generateSegment() {
    let segment = ''
    for (let i = 0; i < this.segmentLength; i++) {
      segment += this.generateSecureRandomChar()
    }
    return segment
  }

  generateLicenseKey() {
    const segments = []
    for (let i = 0; i < this.segmentCount; i++) {
      segments.push(this.generateSegment())
    }
    return segments.join('-')
  }

  generateMultipleLicenses(count = 100) {
    const licenses = []
    const existingKeys = new Set()

    for (let i = 0; i < count; i++) {
      let licenseKey
      let attempts = 0

      do {
        licenseKey = this.generateLicenseKey()
        attempts++
        if (attempts > 100) {
          throw new Error('فشل في إنشاء مفتاح فريد')
        }
      } while (existingKeys.has(licenseKey))

      existingKeys.add(licenseKey)
      licenses.push({
        id: crypto.randomUUID(),
        key: licenseKey,
        hash: crypto.createHash('sha256').update(licenseKey).digest('hex'),
        metadata: {
          licenseType: 'STANDARD',
          region: 'GLOBAL',
          isLifetime: true,
          maxDevices: 1,
          createdAt: new Date().toISOString()
        }
      })
    }

    return licenses
  }
}
```

### 3. مثال على نظام التتبع:

```javascript
const crypto = require('crypto')
const fs = require('fs')
const path = require('path')

class UsedLicensesTracker {
  constructor() {
    this.usedLicensesFile = path.join(__dirname, 'used-licenses.json')
    this.usedLicenses = this.loadUsedLicenses()
  }

  hashLicenseKey(licenseKey) {
    return crypto.createHash('sha256').update(licenseKey).digest('hex')
  }

  loadUsedLicenses() {
    try {
      if (fs.existsSync(this.usedLicensesFile)) {
        const data = JSON.parse(fs.readFileSync(this.usedLicensesFile, 'utf8'))
        return data.usedLicenses || {}
      }
    } catch (error) {
      console.error('Error loading used licenses:', error)
    }
    return {}
  }

  saveUsedLicenses() {
    try {
      const data = {
        metadata: {
          title: 'Used License Keys Tracker',
          lastUpdated: new Date().toISOString(),
          totalUsedKeys: Object.keys(this.usedLicenses).length
        },
        usedLicenses: this.usedLicenses
      }
      fs.writeFileSync(this.usedLicensesFile, JSON.stringify(data, null, 2), 'utf8')
      return true
    } catch (error) {
      console.error('Error saving used licenses:', error)
      return false
    }
  }

  isLicenseAvailable(licenseKey, currentHWID) {
    const hashedKey = this.hashLicenseKey(licenseKey.trim().toUpperCase())
    const usedLicense = this.usedLicenses[hashedKey]

    if (!usedLicense) {
      return true // المفتاح غير مُستخدم
    }

    // التحقق من أن نفس الجهاز
    return usedLicense.hwid === currentHWID
  }

  markLicenseAsUsed(licenseKey, hwid, additionalData = {}) {
    const hashedKey = this.hashLicenseKey(licenseKey.trim().toUpperCase())
    const now = new Date().toISOString()

    this.usedLicenses[hashedKey] = {
      hwid: hwid,
      activatedAt: now,
      lastValidated: now,
      activationCount: (this.usedLicenses[hashedKey]?.activationCount || 0) + 1,
      ...additionalData
    }

    return this.saveUsedLicenses()
  }
}
```

### 4. مثال على التكامل مع واجهة المستخدم:

```javascript
// في ملف renderer process
const { ipcRenderer } = require('electron')

class LicenseUI {
  constructor() {
    this.initializeUI()
  }

  initializeUI() {
    // عرض معرف الجهاز
    this.displayHardwareID()

    // ربط أحداث الأزرار
    document.getElementById('activateBtn').addEventListener('click', () => {
      this.activateLicense()
    })
  }

  async displayHardwareID() {
    try {
      const hwid = await ipcRenderer.invoke('get-hardware-id')
      document.getElementById('hardwareId').textContent = hwid
    } catch (error) {
      console.error('Error getting hardware ID:', error)
    }
  }

  async activateLicense() {
    const licenseKey = document.getElementById('licenseInput').value.trim()

    if (!licenseKey) {
      this.showError('يرجى إدخال مفتاح الترخيص')
      return
    }

    this.showLoading(true)

    try {
      const result = await ipcRenderer.invoke('activate-license', licenseKey)

      if (result.isValid) {
        this.showSuccess('تم تفعيل الترخيص بنجاح!')
        this.displayLicenseInfo(result.licenseData)
      } else {
        this.showError(result.error || 'فشل في تفعيل الترخيص')
      }
    } catch (error) {
      this.showError('حدث خطأ أثناء تفعيل الترخيص')
      console.error('License activation error:', error)
    } finally {
      this.showLoading(false)
    }
  }

  showError(message) {
    const errorDiv = document.getElementById('errorMessage')
    errorDiv.textContent = message
    errorDiv.style.display = 'block'
    setTimeout(() => errorDiv.style.display = 'none', 5000)
  }

  showSuccess(message) {
    const successDiv = document.getElementById('successMessage')
    successDiv.textContent = message
    successDiv.style.display = 'block'
    setTimeout(() => successDiv.style.display = 'none', 5000)
  }

  showLoading(show) {
    document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none'
    document.getElementById('activateBtn').disabled = show
  }
}

// تهيئة واجهة المستخدم
new LicenseUI()
```

### 5. مثال على HTML للواجهة:

```html
<!DOCTYPE html>
<html>
<head>
    <title>تفعيل الترخيص</title>
    <style>
        .container { max-width: 500px; margin: 50px auto; padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #007cba; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .error { color: red; background: #ffe6e6; padding: 10px; border-radius: 4px; display: none; }
        .success { color: green; background: #e6ffe6; padding: 10px; border-radius: 4px; display: none; }
        .hardware-id { background: #f5f5f5; padding: 10px; border-radius: 4px; font-family: monospace; }
    </style>
</head>
<body>
    <div class="container">
        <h2>تفعيل ترخيص النظام</h2>

        <div class="form-group">
            <label>معرف الجهاز:</label>
            <div class="hardware-id" id="hardwareId">جاري التحميل...</div>
        </div>

        <div class="form-group">
            <label for="licenseInput">مفتاح الترخيص:</label>
            <input type="text" id="licenseInput" placeholder="XXXXX-XXXXX-XXXXX-XXXXX" maxlength="23">
        </div>

        <div class="form-group">
            <button id="activateBtn">تفعيل الترخيص</button>
            <div id="loadingSpinner" style="display: none;">جاري التفعيل...</div>
        </div>

        <div id="errorMessage" class="error"></div>
        <div id="successMessage" class="success"></div>

        <div id="licenseInfo" style="display: none;">
            <h3>معلومات الترخيص:</h3>
            <div id="licenseDetails"></div>
        </div>
    </div>

    <script src="license-ui.js"></script>
</body>
</html>
```

## خطوات التطبيق:

1. **إنشاء المجلد الأساسي**: `license-system/`
2. **تثبيت التبعيات**: `npm install node-machine-id electron-store`
3. **إنشاء الملفات الأساسية** حسب الأمثلة أعلاه
4. **اختبار النظام** باستخدام مفاتيح تجريبية
5. **دمج النظام** مع تطبيق Electron الرئيسي
6. **إنشاء واجهة المستخدم** للتفعيل والإدارة

هذا النظام يوفر حماية شاملة وقوية مع سهولة في التطبيق والاستخدام.

---

## ميزات الأمان المتقدمة

### 1. حماية ضد التلاعب:

```javascript
class SecurityManager {
  // فحص تكامل الملفات
  verifyFileIntegrity() {
    const criticalFiles = [
      'licenseManager.js',
      'productionLicenseValidator.js',
      'usedLicensesTracker.js'
    ]

    return criticalFiles.every(file => {
      const content = fs.readFileSync(file, 'utf8')
      const hash = crypto.createHash('sha256').update(content).digest('hex')
      return this.verifyFileHash(file, hash)
    })
  }

  // كشف محاولات التصحيح
  detectDebugging() {
    const startTime = Date.now()
    debugger; // سيتوقف هنا إذا كان المصحح مفتوحاً
    const endTime = Date.now()

    return (endTime - startTime) > 100 // إذا استغرق أكثر من 100ms
  }

  // حماية ضد تحليل الذاكرة
  obfuscateMemory() {
    const dummyData = []
    for (let i = 0; i < 1000; i++) {
      dummyData.push(crypto.randomBytes(32).toString('hex'))
    }
    return dummyData
  }
}
```

### 2. نظام التحقق المتعدد المستويات:

```javascript
class MultiLevelValidator {
  async validateLicense(licenseKey, hwid) {
    const validations = [
      this.validateFormat(licenseKey),
      this.validateChecksum(licenseKey),
      this.validateHardwareBinding(licenseKey, hwid),
      this.validateTimeStamp(licenseKey),
      this.validateUsageLimit(licenseKey),
      this.validateRegionalRestrictions(licenseKey)
    ]

    const results = await Promise.all(validations)
    return results.every(result => result.isValid)
  }

  validateChecksum(licenseKey) {
    // حساب checksum للتحقق من صحة المفتاح
    const segments = licenseKey.split('-')
    const dataSegments = segments.slice(0, -1).join('')
    const checksumSegment = segments[segments.length - 1]

    const calculatedChecksum = this.calculateChecksum(dataSegments)
    return calculatedChecksum === checksumSegment
  }

  calculateChecksum(data) {
    let sum = 0
    for (let i = 0; i < data.length; i++) {
      sum += data.charCodeAt(i) * (i + 1)
    }
    return (sum % 36).toString(36).toUpperCase().padStart(5, '0')
  }
}
```

### 3. نظام الحماية من القرصنة:

```javascript
class AntiPiracySystem {
  constructor() {
    this.suspiciousActivities = []
    this.maxSuspiciousActivities = 5
  }

  // مراقبة الأنشطة المشبوهة
  monitorSuspiciousActivity() {
    setInterval(() => {
      if (this.detectVirtualMachine()) {
        this.logSuspiciousActivity('Virtual Machine Detected')
      }

      if (this.detectMultipleInstances()) {
        this.logSuspiciousActivity('Multiple Instances Running')
      }

      if (this.detectTimeManipulation()) {
        this.logSuspiciousActivity('System Time Manipulation')
      }
    }, 30000) // كل 30 ثانية
  }

  detectVirtualMachine() {
    const vmIndicators = [
      process.env.VBOX_USER_HOME,
      process.env.VMWARE_USER,
      process.platform === 'linux' && fs.existsSync('/proc/vz'),
      process.platform === 'win32' && this.checkWindowsVM()
    ]

    return vmIndicators.some(indicator => indicator)
  }

  detectMultipleInstances() {
    // فحص العمليات الجارية للبحث عن نسخ متعددة
    const { execSync } = require('child_process')
    try {
      const processes = execSync('tasklist', { encoding: 'utf8' })
      const appProcesses = processes.split('\n').filter(line =>
        line.includes('your-app-name.exe')
      )
      return appProcesses.length > 1
    } catch (error) {
      return false
    }
  }

  logSuspiciousActivity(activity) {
    this.suspiciousActivities.push({
      activity,
      timestamp: Date.now(),
      hwid: this.getCurrentHWID()
    })

    if (this.suspiciousActivities.length >= this.maxSuspiciousActivities) {
      this.triggerSecurityResponse()
    }
  }

  triggerSecurityResponse() {
    // إجراءات الأمان عند اكتشاف أنشطة مشبوهة
    console.warn('🚨 Security Alert: Suspicious activities detected')

    // يمكن إضافة إجراءات مثل:
    // - إرسال تقرير للخادم
    // - تعطيل الترخيص مؤقتاً
    // - طلب إعادة تفعيل
  }
}
```

### 4. نظام النسخ الاحتياطي والاستعادة:

```javascript
class LicenseBackupManager {
  constructor() {
    this.backupPath = path.join(app.getPath('userData'), 'license-backup')
    this.ensureBackupDirectory()
  }

  ensureBackupDirectory() {
    if (!fs.existsSync(this.backupPath)) {
      fs.mkdirSync(this.backupPath, { recursive: true })
    }
  }

  // إنشاء نسخة احتياطية مشفرة
  createBackup(licenseData) {
    const backupData = {
      timestamp: Date.now(),
      version: '1.0.0',
      licenseData: this.encryptBackupData(licenseData),
      checksum: this.calculateBackupChecksum(licenseData)
    }

    const backupFile = path.join(this.backupPath, `license-backup-${Date.now()}.json`)
    fs.writeFileSync(backupFile, JSON.stringify(backupData, null, 2))

    // الاحتفاظ بآخر 5 نسخ احتياطية فقط
    this.cleanOldBackups()

    return backupFile
  }

  // استعادة من النسخة الاحتياطية
  restoreFromBackup(backupFile) {
    try {
      const backupData = JSON.parse(fs.readFileSync(backupFile, 'utf8'))
      const decryptedData = this.decryptBackupData(backupData.licenseData)

      // التحقق من تكامل البيانات
      const calculatedChecksum = this.calculateBackupChecksum(decryptedData)
      if (calculatedChecksum !== backupData.checksum) {
        throw new Error('Backup data integrity check failed')
      }

      return decryptedData
    } catch (error) {
      console.error('Error restoring from backup:', error)
      return null
    }
  }

  cleanOldBackups() {
    const backupFiles = fs.readdirSync(this.backupPath)
      .filter(file => file.startsWith('license-backup-'))
      .map(file => ({
        name: file,
        path: path.join(this.backupPath, file),
        mtime: fs.statSync(path.join(this.backupPath, file)).mtime
      }))
      .sort((a, b) => b.mtime - a.mtime)

    // حذف الملفات الزائدة عن 5
    if (backupFiles.length > 5) {
      backupFiles.slice(5).forEach(file => {
        fs.unlinkSync(file.path)
      })
    }
  }
}
```

### 5. نظام التحديث الآمن للتراخيص:

```javascript
class LicenseUpdateManager {
  constructor() {
    this.updateServerUrl = 'https://your-license-server.com/api'
    this.publicKey = this.loadPublicKey()
  }

  // التحقق من التحديثات
  async checkForUpdates(currentLicense) {
    try {
      const response = await fetch(`${this.updateServerUrl}/check-updates`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          licenseKey: currentLicense.key,
          hwid: currentLicense.hwid,
          version: currentLicense.version
        })
      })

      const updateInfo = await response.json()

      if (updateInfo.hasUpdate) {
        return this.verifyUpdateSignature(updateInfo)
      }

      return { hasUpdate: false }
    } catch (error) {
      console.error('Error checking for updates:', error)
      return { hasUpdate: false, error: error.message }
    }
  }

  // التحقق من توقيع التحديث
  verifyUpdateSignature(updateInfo) {
    const { signature, data } = updateInfo
    const verifier = crypto.createVerify('RSA-SHA256')
    verifier.update(JSON.stringify(data))

    const isValid = verifier.verify(this.publicKey, signature, 'base64')

    if (isValid) {
      return { hasUpdate: true, updateData: data }
    } else {
      throw new Error('Invalid update signature')
    }
  }

  // تطبيق التحديث
  async applyUpdate(updateData) {
    // إنشاء نسخة احتياطية قبل التحديث
    const backupManager = new LicenseBackupManager()
    const currentLicense = await this.getCurrentLicense()
    backupManager.createBackup(currentLicense)

    try {
      // تطبيق التحديث
      await this.updateLicenseData(updateData)
      return { success: true }
    } catch (error) {
      // استعادة من النسخة الاحتياطية في حالة الفشل
      await this.rollbackUpdate(backupManager)
      throw error
    }
  }
}
```

### 6. مراقبة الأداء والإحصائيات:

```javascript
class LicenseAnalytics {
  constructor() {
    this.metrics = {
      activationAttempts: 0,
      successfulActivations: 0,
      failedActivations: 0,
      validationChecks: 0,
      suspiciousActivities: 0,
      lastActivity: null
    }
  }

  // تسجيل محاولة التفعيل
  logActivationAttempt(licenseKey, success, error = null) {
    this.metrics.activationAttempts++
    this.metrics.lastActivity = Date.now()

    if (success) {
      this.metrics.successfulActivations++
    } else {
      this.metrics.failedActivations++
      this.logFailureReason(error)
    }

    this.saveMetrics()
  }

  // تسجيل فحص التحقق
  logValidationCheck(isValid) {
    this.metrics.validationChecks++
    this.metrics.lastActivity = Date.now()

    if (!isValid) {
      this.metrics.suspiciousActivities++
    }

    this.saveMetrics()
  }

  // إنشاء تقرير الاستخدام
  generateUsageReport() {
    const uptime = Date.now() - (this.metrics.firstActivation || Date.now())

    return {
      totalActivationAttempts: this.metrics.activationAttempts,
      successRate: (this.metrics.successfulActivations / this.metrics.activationAttempts * 100).toFixed(2),
      totalValidationChecks: this.metrics.validationChecks,
      suspiciousActivities: this.metrics.suspiciousActivities,
      uptime: this.formatUptime(uptime),
      lastActivity: new Date(this.metrics.lastActivity).toISOString()
    }
  }

  formatUptime(milliseconds) {
    const seconds = Math.floor(milliseconds / 1000)
    const minutes = Math.floor(seconds / 60)
    const hours = Math.floor(minutes / 60)
    const days = Math.floor(hours / 24)

    return `${days}d ${hours % 24}h ${minutes % 60}m ${seconds % 60}s`
  }
}
```

## نصائح للتطبيق الآمن:

### 1. **إخفاء الكود الحساس**:
- استخدم أدوات obfuscation للكود الحساس
- اعتمد على native modules للعمليات الحرجة
- احفظ المفاتيح الحساسة في متغيرات البيئة

### 2. **مراقبة النظام**:
- راقب استخدام الذاكرة والمعالج
- اكتشف محاولات التصحيح والتحليل
- سجل جميع الأنشطة المشبوهة

### 3. **التحديث الآمن**:
- استخدم التوقيع الرقمي للتحديثات
- تحقق من تكامل الملفات قبل التطبيق
- احتفظ بنسخ احتياطية قبل أي تحديث

### 4. **الاتصال الآمن**:
- استخدم HTTPS لجميع الاتصالات
- طبق certificate pinning
- اعتمد على التشفير من طرف إلى طرف

هذا النظام المتقدم يوفر حماية شاملة ومتعددة المستويات ضد جميع أنواع القرصنة والتلاعب.

---

## ملفات التكوين والبيانات

### 1. ملف package.json للتبعيات:

```json
{
  "name": "secure-license-system",
  "version": "1.0.0",
  "description": "نظام ترخيص آمن ومتقدم",
  "main": "main.js",
  "dependencies": {
    "electron": "^22.0.0",
    "electron-store": "^8.1.0",
    "node-machine-id": "^1.1.12"
  },
  "devDependencies": {
    "electron-builder": "^24.0.0",
    "jest": "^29.0.0"
  },
  "scripts": {
    "start": "electron .",
    "build": "electron-builder",
    "test": "jest",
    "generate-licenses": "node scripts/generateProductionLicenses.js",
    "test-license-system": "node scripts/testLicenseSystem.js"
  }
}
```

### 2. ملف إعدادات النظام (config.json):

```json
{
  "license": {
    "format": {
      "regex": "^[A-Z0-9]{4,5}-[A-Z0-9]{4,5}-[A-Z0-9]{4,5}-[A-Z0-9]{4,5}$",
      "segmentLength": 5,
      "segmentCount": 4,
      "separator": "-"
    },
    "encryption": {
      "algorithm": "aes-256-gcm",
      "keyDerivationIterations": 100000,
      "saltLength": 32
    },
    "security": {
      "maxActivationAttempts": 5,
      "suspiciousActivityThreshold": 3,
      "validationInterval": 300000,
      "backupRetentionDays": 30
    },
    "features": {
      "hardwareBinding": true,
      "antiDebugging": true,
      "virtualMachineDetection": true,
      "multiInstancePrevention": true,
      "automaticBackup": true
    }
  },
  "server": {
    "updateCheckUrl": "https://your-server.com/api/license/check",
    "activationUrl": "https://your-server.com/api/license/activate",
    "validationUrl": "https://your-server.com/api/license/validate",
    "timeout": 30000,
    "retryAttempts": 3
  }
}
```

### 3. سكريبت اختبار شامل:

```javascript
// scripts/testLicenseSystem.js
const LicenseManager = require('../electron/licenseManager')
const LicenseKeyGenerator = require('../scripts/licenseGenerator')
const UsedLicensesTracker = require('../electron/usedLicensesTracker')

class LicenseSystemTester {
  constructor() {
    this.licenseManager = new LicenseManager()
    this.keyGenerator = new LicenseKeyGenerator()
    this.tracker = new UsedLicensesTracker()
    this.testResults = []
  }

  async runAllTests() {
    console.log('🧪 بدء اختبار نظام التراخيص الشامل...\n')

    await this.testKeyGeneration()
    await this.testLicenseActivation()
    await this.testHardwareBinding()
    await this.testSecurityFeatures()
    await this.testErrorHandling()
    await this.testPerformance()

    this.generateTestReport()
  }

  async testKeyGeneration() {
    console.log('📝 اختبار توليد المفاتيح...')

    try {
      // اختبار توليد مفتاح واحد
      const singleKey = this.keyGenerator.generateLicenseKey()
      this.assert(
        this.licenseManager.validateLicenseFormat(singleKey),
        'توليد مفتاح واحد صحيح'
      )

      // اختبار توليد مفاتيح متعددة
      const multipleKeys = this.keyGenerator.generateMultipleLicenses(10)
      this.assert(
        multipleKeys.length === 10,
        'توليد 10 مفاتيح'
      )

      // اختبار عدم التكرار
      const keySet = new Set(multipleKeys.map(k => k.key))
      this.assert(
        keySet.size === multipleKeys.length,
        'عدم تكرار المفاتيح'
      )

      console.log('✅ اختبار توليد المفاتيح نجح\n')
    } catch (error) {
      console.error('❌ فشل اختبار توليد المفاتيح:', error.message)
    }
  }

  async testLicenseActivation() {
    console.log('🔑 اختبار تفعيل التراخيص...')

    try {
      // إنشاء مفتاح اختبار
      const testKey = 'TEST1-ABCDE-12345-FGHIJ'

      // اختبار التفعيل الناجح
      const activationResult = await this.licenseManager.activateLicense(testKey)
      this.assert(
        activationResult.isValid,
        'تفعيل مفتاح صحيح'
      )

      // اختبار التحقق من الترخيص المحفوظ
      const validationResult = await this.licenseManager.validateStoredLicense()
      this.assert(
        validationResult.isValid,
        'التحقق من الترخيص المحفوظ'
      )

      console.log('✅ اختبار تفعيل التراخيص نجح\n')
    } catch (error) {
      console.error('❌ فشل اختبار تفعيل التراخيص:', error.message)
    }
  }

  async testHardwareBinding() {
    console.log('🔒 اختبار ربط الأجهزة...')

    try {
      // الحصول على معرف الجهاز
      const hwid = this.licenseManager.generateHWID()
      this.assert(
        hwid && hwid.length === 32,
        'توليد معرف جهاز صحيح'
      )

      // اختبار ربط المفتاح بالجهاز
      const testKey = 'HWTEST-12345-ABCDE-FGHIJ'
      const bindingResult = await this.licenseManager.activateLicense(testKey)

      this.assert(
        bindingResult.isValid && bindingResult.licenseData.hwid === hwid,
        'ربط المفتاح بالجهاز'
      )

      console.log('✅ اختبار ربط الأجهزة نجح\n')
    } catch (error) {
      console.error('❌ فشل اختبار ربط الأجهزة:', error.message)
    }
  }

  async testSecurityFeatures() {
    console.log('🛡️ اختبار ميزات الأمان...')

    try {
      // اختبار التشفير وفك التشفير
      const testData = { test: 'data', number: 123 }
      const encrypted = this.licenseManager.encryptLicenseData(testData)
      const decrypted = this.licenseManager.decryptLicenseData(encrypted)

      this.assert(
        JSON.stringify(testData) === JSON.stringify(decrypted),
        'تشفير وفك تشفير البيانات'
      )

      // اختبار كشف التلاعب
      const invalidFormat = 'INVALID-FORMAT'
      const formatValidation = this.licenseManager.validateLicenseFormat(invalidFormat)
      this.assert(
        !formatValidation,
        'رفض التنسيق غير الصحيح'
      )

      console.log('✅ اختبار ميزات الأمان نجح\n')
    } catch (error) {
      console.error('❌ فشل اختبار ميزات الأمان:', error.message)
    }
  }

  async testErrorHandling() {
    console.log('⚠️ اختبار معالجة الأخطاء...')

    try {
      // اختبار مفتاح فارغ
      const emptyKeyResult = await this.licenseManager.activateLicense('')
      this.assert(
        !emptyKeyResult.isValid,
        'رفض المفتاح الفارغ'
      )

      // اختبار مفتاح بتنسيق خاطئ
      const wrongFormatResult = await this.licenseManager.activateLicense('WRONG-FORMAT')
      this.assert(
        !wrongFormatResult.isValid,
        'رفض التنسيق الخاطئ'
      )

      console.log('✅ اختبار معالجة الأخطاء نجح\n')
    } catch (error) {
      console.error('❌ فشل اختبار معالجة الأخطاء:', error.message)
    }
  }

  async testPerformance() {
    console.log('⚡ اختبار الأداء...')

    try {
      // اختبار سرعة توليد المفاتيح
      const startTime = Date.now()
      this.keyGenerator.generateMultipleLicenses(100)
      const generationTime = Date.now() - startTime

      this.assert(
        generationTime < 5000,
        `توليد 100 مفتاح في أقل من 5 ثوان (${generationTime}ms)`
      )

      // اختبار سرعة التحقق
      const validationStartTime = Date.now()
      for (let i = 0; i < 100; i++) {
        this.licenseManager.validateLicenseFormat('TEST1-ABCDE-12345-FGHIJ')
      }
      const validationTime = Date.now() - validationStartTime

      this.assert(
        validationTime < 1000,
        `100 عملية تحقق في أقل من ثانية (${validationTime}ms)`
      )

      console.log('✅ اختبار الأداء نجح\n')
    } catch (error) {
      console.error('❌ فشل اختبار الأداء:', error.message)
    }
  }

  assert(condition, testName) {
    const result = {
      test: testName,
      passed: condition,
      timestamp: new Date().toISOString()
    }

    this.testResults.push(result)

    if (condition) {
      console.log(`  ✅ ${testName}`)
    } else {
      console.log(`  ❌ ${testName}`)
    }
  }

  generateTestReport() {
    const totalTests = this.testResults.length
    const passedTests = this.testResults.filter(r => r.passed).length
    const failedTests = totalTests - passedTests
    const successRate = ((passedTests / totalTests) * 100).toFixed(2)

    console.log('\n' + '='.repeat(60))
    console.log('📊 تقرير اختبار نظام التراخيص')
    console.log('='.repeat(60))
    console.log(`إجمالي الاختبارات: ${totalTests}`)
    console.log(`الاختبارات الناجحة: ${passedTests}`)
    console.log(`الاختبارات الفاشلة: ${failedTests}`)
    console.log(`معدل النجاح: ${successRate}%`)
    console.log('='.repeat(60))

    if (failedTests > 0) {
      console.log('\n❌ الاختبارات الفاشلة:')
      this.testResults
        .filter(r => !r.passed)
        .forEach(r => console.log(`  - ${r.test}`))
    }

    // حفظ التقرير في ملف
    const reportData = {
      summary: {
        totalTests,
        passedTests,
        failedTests,
        successRate: parseFloat(successRate),
        timestamp: new Date().toISOString()
      },
      results: this.testResults
    }

    require('fs').writeFileSync(
      'test-report.json',
      JSON.stringify(reportData, null, 2)
    )

    console.log('\n📄 تم حفظ التقرير في: test-report.json')
  }
}

// تشغيل الاختبارات
if (require.main === module) {
  const tester = new LicenseSystemTester()
  tester.runAllTests().catch(console.error)
}

module.exports = LicenseSystemTester
```

### 4. سكريبت إنشاء مفاتيح الإنتاج:

```javascript
// scripts/generateProductionLicenses.js
const crypto = require('crypto')
const fs = require('fs')
const path = require('path')

const CONFIG = {
  totalKeys: 1000,
  outputFile: 'production-licenses.json',
  charset: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789',
  segmentLength: 5,
  segmentCount: 4
}

class ProductionLicenseGenerator {
  constructor() {
    this.existingKeys = new Set()
  }

  generateSecureLicenseKey() {
    const segments = []
    for (let i = 0; i < CONFIG.segmentCount; i++) {
      segments.push(this.generateSegment())
    }
    return segments.join('-')
  }

  generateSegment() {
    let segment = ''
    for (let i = 0; i < CONFIG.segmentLength; i++) {
      const randomBytes = crypto.randomBytes(1)
      const randomIndex = randomBytes[0] % CONFIG.charset.length
      segment += CONFIG.charset[randomIndex]
    }
    return segment
  }

  generateLicenseMetadata(index) {
    const licenseTypes = ['STANDARD', 'PROFESSIONAL', 'ENTERPRISE', 'PREMIUM']
    const regions = ['GLOBAL', 'MENA', 'GCC', 'SAUDI', 'UAE']

    return {
      keyIndex: index + 1,
      licenseType: licenseTypes[Math.floor(Math.random() * licenseTypes.length)],
      region: regions[Math.floor(Math.random() * regions.length)],
      maxDevices: 1,
      isLifetime: true,
      createdAt: new Date().toISOString(),
      isActive: true,
      isUsed: false
    }
  }

  async generateProductionLicenses() {
    console.log(`🔑 بدء إنشاء ${CONFIG.totalKeys} مفتاح ترخيص للإنتاج...`)

    const licenses = []

    for (let i = 0; i < CONFIG.totalKeys; i++) {
      let licenseKey
      let attempts = 0

      // التأكد من عدم التكرار
      do {
        licenseKey = this.generateSecureLicenseKey()
        attempts++

        if (attempts > 100) {
          throw new Error(`فشل في إنشاء مفتاح فريد بعد ${attempts} محاولة`)
        }
      } while (this.existingKeys.has(licenseKey))

      this.existingKeys.add(licenseKey)

      const licenseData = {
        id: crypto.randomUUID(),
        key: licenseKey,
        hash: crypto.createHash('sha256').update(licenseKey).digest('hex'),
        metadata: this.generateLicenseMetadata(i)
      }

      licenses.push(licenseData)

      // عرض التقدم
      if ((i + 1) % 100 === 0) {
        const progress = ((i + 1) / CONFIG.totalKeys * 100).toFixed(1)
        console.log(`📈 التقدم: ${i + 1}/${CONFIG.totalKeys} (${progress}%)`)
      }
    }

    // حفظ المفاتيح
    const outputData = {
      metadata: {
        title: 'مفاتيح ترخيص الإنتاج',
        version: '1.0.0',
        generatedAt: new Date().toISOString(),
        totalKeys: licenses.length,
        format: 'XXXXX-XXXXX-XXXXX-XXXXX'
      },
      licenses: licenses
    }

    fs.writeFileSync(CONFIG.outputFile, JSON.stringify(outputData, null, 2))
    console.log(`✅ تم إنشاء ${licenses.length} مفتاح وحفظها في: ${CONFIG.outputFile}`)

    return licenses
  }
}

// تشغيل المولد
if (require.main === module) {
  const generator = new ProductionLicenseGenerator()
  generator.generateProductionLicenses().catch(console.error)
}

module.exports = ProductionLicenseGenerator
```

## خطة التطبيق النهائية:

### المرحلة 1: الإعداد الأساسي
1. إنشاء مجلد المشروع
2. تثبيت التبعيات المطلوبة
3. إعداد ملفات التكوين

### المرحلة 2: تطوير المكونات الأساسية
1. إنشاء LicenseManager
2. تطوير مولد المفاتيح
3. بناء نظام التتبع

### المرحلة 3: إضافة ميزات الأمان
1. تطبيق التشفير المتقدم
2. إضافة كشف التلاعب
3. تطوير نظام النسخ الاحتياطي

### المرحلة 4: الاختبار والتحسين
1. تشغيل الاختبارات الشاملة
2. تحسين الأداء
3. إصلاح الأخطاء

### المرحلة 5: التكامل والنشر
1. دمج النظام مع التطبيق الرئيسي
2. إنشاء واجهة المستخدم
3. إعداد التوزيع الآمن

هذا النظام الشامل يوفر حماية قوية ومرونة عالية لأي تطبيق يحتاج نظام ترخيص متقدم.
