/**
 * ูููุฏ ููุงุชูุญ ุงูุชุฑุฎูุต ุงููุฑุชุจุทุฉ ุจุงูุฃุฌูุฒุฉ
 * Device-Bound License Keys Generator
 */

const crypto = require('crypto')
const fs = require('fs')
const path = require('path')
const { 
  deviceBoundGenerator,
  getCurrentDeviceId 
} = require('../electron/deviceBoundLicenseGenerator.js')

/**
 * ุฅูุดุงุก ูุนุฑูุงุช ุฃุฌูุฒุฉ ููููุฉ ููุงุฎุชุจุงุฑ
 */
function generateMockDeviceIds(count) {
  const deviceIds = []
  
  for (let i = 0; i < count; i++) {
    // ุฅูุดุงุก ูุนุฑู ุฌูุงุฒ ูููู
    const randomData = crypto.randomBytes(16).toString('hex')
    const deviceId = crypto.createHash('sha256').update(randomData + i).digest('hex').substring(0, 32)
    deviceIds.push(deviceId)
  }
  
  return deviceIds
}

/**
 * ุฅูุดุงุก ููุงุชูุญ ุชุฑุฎูุต ูุฑุชุจุทุฉ ุจุฃุฌูุฒุฉ
 */
function generateDeviceBoundLicenses(count = 100) {
  console.log('๐ ุจุฏุก ุฅูุดุงุก ููุงุชูุญ ุงูุชุฑุฎูุต ุงููุฑุชุจุทุฉ ุจุงูุฃุฌูุฒุฉ...')
  console.log(`๐ ุงูุนุฏุฏ ุงููุทููุจ: ${count} ููุชุงุญ`)
  console.log('๐ ููุน ุงูุญูุงูุฉ: ูุฑุชุจุท ุจุงูุฌูุงุฒ')
  console.log('')

  const startTime = Date.now()
  const licenses = []
  
  // ุฃููุงุน ุงูุชุฑุงุฎูุต ุงููุฎุชููุฉ
  const licenseTypes = ['STANDARD', 'PROFESSIONAL', 'ENTERPRISE', 'PREMIUM', 'ULTIMATE']
  const regions = ['GLOBAL', 'MENA', 'GCC', 'SAUDI', 'UAE', 'KUWAIT', 'QATAR', 'BAHRAIN', 'OMAN']

  // ุฅูุดุงุก ูุนุฑูุงุช ุฃุฌูุฒุฉ ููููุฉ
  const deviceIds = generateMockDeviceIds(count)
  
  for (let i = 0; i < count; i++) {
    try {
      const deviceId = deviceIds[i]
      
      // ุงุฎุชูุงุฑ ููุน ุชุฑุฎูุต ูููุทูุฉ ุนุดูุงุฆูุฉ
      const licenseType = licenseTypes[Math.floor(Math.random() * licenseTypes.length)]
      const region = regions[Math.floor(Math.random() * regions.length)]
      
      const metadata = {
        keyIndex: i + 1,
        licenseType: licenseType,
        region: region,
        isLifetime: true,
        maxDevices: 1,
        generatedFor: 'commercial-distribution'
      }

      // ุฅูุดุงุก ุงูููุชุงุญ
      const license = deviceBoundGenerator.generateForDevice(deviceId, metadata)
      
      // ุฅุถุงูุฉ ูุนูููุงุช ุฅุถุงููุฉ
      license.id = crypto.randomUUID()
      license.keyIndex = i + 1
      license.deviceIdShort = deviceId.substring(0, 12) + '...'
      
      licenses.push(license)
      
      // ุนุฑุถ ุงูุชูุฏู
      if ((i + 1) % 20 === 0) {
        const progress = ((i + 1) / count * 100).toFixed(1)
        console.log(`๐ ุงูุชูุฏู: ${i + 1}/${count} (${progress}%)`)
      }
      
    } catch (error) {
      console.error(`โ ุฎุทุฃ ูู ุฅูุดุงุก ุงูููุชุงุญ ${i + 1}:`, error.message)
    }
  }

  const endTime = Date.now()
  const duration = (endTime - startTime) / 1000

  console.log('')
  console.log('โ ุชู ุฅูุดุงุก ุฌููุน ุงูููุงุชูุญ ุจูุฌุงุญ!')
  console.log(`โฑ๏ธ ุงูููุช ุงููุณุชุบุฑู: ${duration.toFixed(2)} ุซุงููุฉ`)
  console.log(`๐ข ุฅุฌูุงูู ุงูููุงุชูุญ: ${licenses.length}`)

  return licenses
}

/**
 * ุญูุธ ุงูููุงุชูุญ ูู ููู JSON
 */
function saveLicensesToFile(licenses, filename = 'device-bound-licenses.json') {
  const outputPath = path.join(__dirname, '..', filename)
  
  const fileData = {
    metadata: {
      title: 'ููุงุชูุญ ุชุฑุฎูุต ูุฑุชุจุทุฉ ุจุงูุฃุฌูุฒุฉ',
      description: 'ููุงุชูุญ ุชุฑุฎูุต ูุดูุฑุฉ ููุฑุชุจุทุฉ ุจุฃุฌูุฒุฉ ูุญุฏุฏุฉ - ูุง ุชุนูู ุนูู ุฃุฌูุฒุฉ ุฃุฎุฑู',
      version: '1.0.0',
      generatedAt: new Date().toISOString(),
      totalKeys: licenses.length,
      format: 'XXXXX-XXXX-XXXX-XXXX (Device-Bound)',
      security: 'AES-256 + Device ID Binding',
      generator: 'Device-Bound License Generator v1.0'
    },
    statistics: {
      totalKeys: licenses.length,
      licenseTypes: getLicenseTypeStats(licenses),
      regions: getRegionStats(licenses),
      securityLevel: 'MAXIMUM - Device Bound'
    },
    licenses: licenses
  }

  try {
    fs.writeFileSync(outputPath, JSON.stringify(fileData, null, 2), 'utf8')
    console.log(`๐พ ุชู ุญูุธ ุงูููุงุชูุญ ูู: ${outputPath}`)
    
    // ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ
    const backupPath = path.join(__dirname, '..', `device-bound-licenses-backup-${Date.now()}.json`)
    fs.writeFileSync(backupPath, JSON.stringify(fileData, null, 2), 'utf8')
    console.log(`๐พ ุชู ุญูุธ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ูู: ${backupPath}`)
    
    return outputPath
  } catch (error) {
    console.error('โ ุฎุทุฃ ูู ุญูุธ ุงูููู:', error)
    throw error
  }
}

/**
 * ุฅูุดุงุก ููู ููุงุชูุญ ูุจุณุท ููุชูุฒูุน
 */
function createDistributionFile(licenses) {
  const distributionPath = path.join(__dirname, '..', 'device-bound-keys-distribution.txt')
  
  const header = `# ููุงุชูุญ ุชุฑุฎูุต ูุธุงู ุฅุฏุงุฑุฉ ุงูุนูุงุฏุฉ - ูุฑุชุจุทุฉ ุจุงูุฃุฌูุฒุฉ
# ุชู ุงูุฅูุดุงุก ูู: ${new Date().toLocaleString('ar-SA')}
# ุฅุฌูุงูู ุงูููุงุชูุญ: ${licenses.length}
# ููุน ุงูุชุฑุฎูุต: ูุฏู ุงูุญูุงุฉ - ูุฑุชุจุท ุจุงูุฌูุงุฒ
# ูุณุชูู ุงูุฃูุงู: ุนุงูู ุฌุฏุงู - ูุง ูุนูู ุฅูุง ุนูู ุงูุฌูุงุฒ ุงููุญุฏุฏ
#
# ุชูุณูู ุงูููุชุงุญ: XXXXX-XXXX-XXXX-XXXX
# ูู ููุชุงุญ ูุฑุชุจุท ุจุฌูุงุฒ ูุญุฏุฏ ููุง ูุนูู ุนูู ุฃุฌูุฒุฉ ุฃุฎุฑู
#
# ููุจูุน: ุฃุนุท ูู ุนููู ููุชุงุญ ูุงุญุฏ + ูุนุฑู ุงูุฌูุงุฒ ุงููุทููุจ
# ========================================

`

  const keysData = licenses.map((license, index) => {
    return `${index + 1}. ${license.licenseKey} | Device: ${license.deviceIdShort} | Type: ${license.metadata.licenseType} | Region: ${license.metadata.region}`
  }).join('\n')

  fs.writeFileSync(distributionPath, header + keysData, 'utf8')
  console.log(`๐ ุชู ุญูุธ ููู ุงูุชูุฒูุน ูู: ${distributionPath}`)
  
  return distributionPath
}

/**
 * ุฅุญุตุงุฆูุงุช ุฃููุงุน ุงูุชุฑุงุฎูุต
 */
function getLicenseTypeStats(licenses) {
  const stats = {}
  licenses.forEach(license => {
    const type = license.metadata.licenseType
    stats[type] = (stats[type] || 0) + 1
  })
  return stats
}

/**
 * ุฅุญุตุงุฆูุงุช ุงูููุงุทู
 */
function getRegionStats(licenses) {
  const stats = {}
  licenses.forEach(license => {
    const region = license.metadata.region
    stats[region] = (stats[region] || 0) + 1
  })
  return stats
}

/**
 * ุงุฎุชุจุงุฑ ููุชุงุญ ุนูู ุงูุฌูุงุฒ ุงูุญุงูู
 */
function testCurrentDeviceLicense() {
  console.log('๐งช ุงุฎุชุจุงุฑ ุฅูุดุงุก ููุชุงุญ ููุฌูุงุฒ ุงูุญุงูู...')
  
  const currentDeviceId = getCurrentDeviceId()
  console.log(`๐ป ูุนุฑู ุงูุฌูุงุฒ ุงูุญุงูู: ${currentDeviceId.substring(0, 12)}...`)
  
  // ุฅูุดุงุก ููุชุงุญ ููุฌูุงุฒ ุงูุญุงูู
  const license = deviceBoundGenerator.generateForCurrentDevice({
    licenseType: 'TEST',
    region: 'LOCAL',
    purpose: 'testing'
  })
  
  console.log(`๐ ุงูููุชุงุญ ุงููููุดุฃ: ${license.licenseKey}`)
  
  // ุงุฎุชุจุงุฑ ุงูุชุญูู
  const validation = deviceBoundGenerator.validateDeviceBoundLicense(license.licenseKey)
  
  if (validation.isValid) {
    console.log('โ ุงูุงุฎุชุจุงุฑ ูุฌุญ - ุงูููุชุงุญ ูุนูู ุนูู ุงูุฌูุงุฒ ุงูุญุงูู')
    console.log(`๐ ููุน ุงูุชุฑุฎูุต: ${validation.licenseData.metadata.licenseType}`)
  } else {
    console.log('โ ุงูุงุฎุชุจุงุฑ ูุดู:', validation.error)
  }
  
  return validation.isValid
}

/**
 * ุนุฑุถ ููุฎุต ุงููุชุงุฆุฌ
 */
function displaySummary(licenses, outputPath) {
  console.log('\n๐ ููุฎุต ุงููุชุงุฆุฌ:')
  console.log('=' .repeat(60))
  console.log(`๐ข ุฅุฌูุงูู ุงูููุงุชูุญ: ${licenses.length}`)
  console.log(`๐ ููู ุงูุฅุฎุฑุงุฌ: ${path.basename(outputPath)}`)
  console.log(`๐พ ุญุฌู ุงูููู: ${(fs.statSync(outputPath).size / 1024 / 1024).toFixed(2)} MB`)
  console.log(`๐ ูุณุชูู ุงูุฃูุงู: ุนุงูู ุฌุฏุงู - ูุฑุชุจุท ุจุงูุฌูุงุฒ`)
  
  console.log('\n๐ ุฅุญุตุงุฆูุงุช ุฃููุงุน ุงูุชุฑุงุฎูุต:')
  const typeStats = getLicenseTypeStats(licenses)
  Object.entries(typeStats).forEach(([type, count]) => {
    console.log(`   ${type}: ${count} ููุชุงุญ`)
  })
  
  console.log('\n๐ ุฅุญุตุงุฆูุงุช ุงูููุงุทู:')
  const regionStats = getRegionStats(licenses)
  Object.entries(regionStats).forEach(([region, count]) => {
    console.log(`   ${region}: ${count} ููุชุงุญ`)
  })
  
  console.log('\n๐ก๏ธ ูุฒุงูุง ุงููุธุงู ุงูุฌุฏูุฏ:')
  console.log('   โข ูู ููุชุงุญ ูุฑุชุจุท ุจุฌูุงุฒ ูุญุฏุฏ')
  console.log('   โข ูุง ูููู ุงุณุชุฎุฏุงู ุงูููุชุงุญ ุนูู ุฃุฌูุฒุฉ ุฃุฎุฑู')
  console.log('   โข ูุง ูุญุชุงุฌ ุงุชุตุงู ุฅูุชุฑูุช ููุชุญูู')
  console.log('   โข ุญูุงูุฉ ูุทููุฉ ุถุฏ ุงููุฑุตูุฉ')
  console.log('   โข ุชุดููุฑ AES-256 ูุน ุฑุจุท ุงูุฌูุงุฒ')
}

/**
 * ุฅูุดุงุก ููุชุงุญ ุชุฑุฎูุต ููุนุฑู ุฌูุงุฒ ูุญุฏุฏ
 */
function generateLicenseForSpecificDevice(deviceId, metadata = {}) {
  console.log('๐ ุฅูุดุงุก ููุชุงุญ ุชุฑุฎูุต ููุนุฑู ุฌูุงุฒ ูุญุฏุฏ...')
  console.log(`๐ป ูุนุฑู ุงูุฌูุงุฒ: ${deviceId}`)
  console.log('')

  try {
    // ุฅุนุฏุงุฏ ุงูุจูุงูุงุช ุงููุตููุฉ ุงูุงูุชุฑุงุถูุฉ
    const defaultMetadata = {
      licenseType: 'PREMIUM',
      region: 'GLOBAL',
      isLifetime: true,
      maxDevices: 1,
      generatedFor: 'specific-device-activation',
      customActivation: true
    }

    const finalMetadata = { ...defaultMetadata, ...metadata }

    // ุฅูุดุงุก ุงูููุชุงุญ
    const license = deviceBoundGenerator.generateForDevice(deviceId, finalMetadata)

    // ุฅุถุงูุฉ ูุนูููุงุช ุฅุถุงููุฉ
    license.id = crypto.randomUUID()
    license.deviceIdShort = deviceId.substring(0, 12) + '...'
    license.fullDeviceId = deviceId

    console.log('โ ุชู ุฅูุดุงุก ุงูููุชุงุญ ุจูุฌุงุญ!')
    console.log(`๐ ููุชุงุญ ุงูุชุฑุฎูุต: ${license.licenseKey}`)
    console.log(`๐ ููุน ุงูุชุฑุฎูุต: ${license.metadata.licenseType}`)
    console.log(`๐ ุงูููุทูุฉ: ${license.metadata.region}`)
    console.log(`๐ป ูุนุฑู ุงูุฌูุงุฒ: ${license.deviceIdShort}`)
    console.log('')

    // ุญูุธ ุงูููุชุงุญ ูู ููู ูููุตู
    const outputPath = path.join(__dirname, '..', `license-${deviceId.substring(0, 8)}.json`)
    const licenseData = {
      metadata: {
        title: 'ููุชุงุญ ุชุฑุฎูุต ูุฎุตุต',
        description: `ููุชุงุญ ุชุฑุฎูุต ูุฑุชุจุท ุจุงูุฌูุงุฒ ${deviceId}`,
        version: '1.0.0',
        generatedAt: new Date().toISOString(),
        deviceId: deviceId,
        generator: 'Custom Device License Generator v1.0'
      },
      license: license
    }

    fs.writeFileSync(outputPath, JSON.stringify(licenseData, null, 2), 'utf8')
    console.log(`๐พ ุชู ุญูุธ ุงูููุชุงุญ ูู: ${outputPath}`)

    return license

  } catch (error) {
    console.error('โ ุฎุทุฃ ูู ุฅูุดุงุก ุงูููุชุงุญ:', error.message)
    throw error
  }
}

/**
 * ุงูุฏุงูุฉ ุงูุฑุฆูุณูุฉ
 */
function main() {
  const args = process.argv.slice(2)
  const command = args[0] || 'generate'
  const count = parseInt(args[1]) || 100

  console.log('๐ญ ูููุฏ ููุงุชูุญ ุงูุชุฑุฎูุต ุงููุฑุชุจุทุฉ ุจุงูุฃุฌูุฒุฉ')
  console.log('=' .repeat(70))
  console.log(`๐ ุงูุชุงุฑูุฎ: ${new Date().toLocaleString('ar-SA')}`)
  console.log('')

  switch (command.toLowerCase()) {
    case 'generate':
      try {
        console.log(`๐ฏ ุงููุฏู: ุฅูุดุงุก ${count} ููุชุงุญ ุชุฑุฎูุต ูุฑุชุจุท ุจุงูุฌูุงุฒ`)
        console.log('')

        // ุฅูุดุงุก ุงูููุงุชูุญ
        const licenses = generateDeviceBoundLicenses(count)

        // ุญูุธ ุงููููุงุช
        const outputPath = saveLicensesToFile(licenses)
        createDistributionFile(licenses)

        // ุนุฑุถ ุงูููุฎุต
        displaySummary(licenses, outputPath)

        console.log('\n๐ ุชู ุฅูุดุงุก ููุงุชูุญ ุงูุชุฑุฎูุต ุงููุฑุชุจุทุฉ ุจุงูุฃุฌูุฒุฉ ุจูุฌุงุญ!')
        console.log('โ ุฌุงูุฒ ููุงุณุชุฎุฏุงู ุงูุชุฌุงุฑู ูุน ุญูุงูุฉ ูุทููุฉ!')

      } catch (error) {
        console.error('\nโ ุฎุทุฃ ูู ุฅูุดุงุก ููุงุชูุญ ุงูุชุฑุฎูุต:', error.message)
        process.exit(1)
      }
      break

    case 'custom':
      try {
        const deviceId = args[1]
        if (!deviceId) {
          console.log('โ ูุฌุจ ุชุญุฏูุฏ ูุนุฑู ุงูุฌูุงุฒ')
          console.log('๐ก ุงูุงุณุชุฎุฏุงู: node scripts/generateDeviceBoundLicenses.js custom <device-id>')
          process.exit(1)
        }

        const metadata = {
          licenseType: args[2] || 'PREMIUM',
          region: args[3] || 'GLOBAL'
        }

        generateLicenseForSpecificDevice(deviceId, metadata)

      } catch (error) {
        console.error('\nโ ุฎุทุฃ ูู ุฅูุดุงุก ุงูููุชุงุญ ุงููุฎุตุต:', error.message)
        process.exit(1)
      }
      break

    case 'test':
      testCurrentDeviceLicense()
      break

    default:
      console.log('๐ ุงูุงุณุชุฎุฏุงู:')
      console.log('   node scripts/generateDeviceBoundLicenses.js generate [ุนุฏุฏ]')
      console.log('   node scripts/generateDeviceBoundLicenses.js custom <device-id> [ููุน] [ููุทูุฉ]')
      console.log('   node scripts/generateDeviceBoundLicenses.js test')
      console.log('')
      console.log('๐ก ุฃูุซูุฉ:')
      console.log('   node scripts/generateDeviceBoundLicenses.js generate 500')
      console.log('   node scripts/generateDeviceBoundLicenses.js custom e0bfdd535d9146cc80514f9ce2f93c45 PREMIUM GLOBAL')
      console.log('   node scripts/generateDeviceBoundLicenses.js test')
      break
  }
}

// ุชุดุบูู ุงูุฏุงูุฉ ุงูุฑุฆูุณูุฉ
if (require.main === module) {
  main()
}

module.exports = {
  generateDeviceBoundLicenses,
  saveLicensesToFile,
  testCurrentDeviceLicense,
  generateLicenseForSpecificDevice
}
